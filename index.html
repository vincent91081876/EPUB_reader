<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB é–±è®€å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }

        /* é ‚éƒ¨å·¥å…·æ¬„ */
        .toolbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toolbar h1 {
            font-size: 24px;
            margin-right: 20px;
        }

        .btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .file-input {
            display: none;
        }

        /* ä¸»å…§å®¹å€åŸŸ */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* å´é‚Šæ¬„ */
        .sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
            width: 0;
        }

        .sidebar-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #dee2e6;
        }

        .sidebar-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            transition: all 0.3s;
            font-size: 14px;
        }

        .sidebar-tab.active {
            background: white;
            border-bottom: 3px solid #667eea;
            color: #667eea;
            font-weight: bold;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* ç›®éŒ„æ¨£å¼ */
        .toc-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .toc-item:hover {
            background: #e9ecef;
            border-left-color: #667eea;
            transform: translateX(5px);
        }

        .toc-item.level-2 {
            margin-left: 15px;
            font-size: 14px;
        }

        .toc-item.level-3 {
            margin-left: 30px;
            font-size: 13px;
        }

        /* æ›¸ç±¤æ¨£å¼ */
        .bookmark-item {
            padding: 12px;
            margin: 8px 0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #ffc107;
        }

        .bookmark-item:hover {
            background: #fff3cd;
            transform: translateX(5px);
        }

        .bookmark-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .bookmark-text {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
        }

        .bookmark-time {
            font-size: 11px;
            color: #999;
        }

        .bookmark-delete {
            float: right;
            color: #dc3545;
            font-size: 12px;
            padding: 2px 8px;
            background: #fff;
            border: 1px solid #dc3545;
            border-radius: 4px;
            cursor: pointer;
        }

        .bookmark-delete:hover {
            background: #dc3545;
            color: white;
        }

        /* æœç´¢æ¨£å¼ */
        .search-box {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .search-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-result {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid #28a745;
        }

        .search-result:hover {
            background: #d4edda;
            transform: translateX(5px);
        }

        .search-result-text {
            font-size: 13px;
            color: #333;
        }

        .search-result-text mark {
            background: #ffc107;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* é–±è®€å€åŸŸ */
        .reader-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #faf8f5;
        }

        .reader-controls {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            color: #333;
        }

        .control-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .font-size-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .font-size-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .font-size-btn:hover {
            background: #667eea;
            color: white;
        }

        .theme-selector {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }

        /* é–±è®€å…§å®¹ */
        .reader-content {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
        }

        #content {
            max-width: 800px;
            margin: 0 auto;
            font-size: 18px;
            line-height: 1.8;
            color: #333;
        }

        #content h1, #content h2, #content h3 {
            margin: 30px 0 20px;
            color: #222;
        }

        #content p {
            margin: 15px 0;
            text-align: justify;
        }

        #content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 20px auto;
            border-radius: 8px;
        }

        /* é€²åº¦æ¢ */
        .progress-bar {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .progress-track {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            position: relative;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            min-width: 100px;
            text-align: right;
        }

        /* ä¸»é¡Œæ¨£å¼ */
        .theme-light {
            background: #faf8f5;
        }

        .theme-light #content {
            color: #333;
        }

        .theme-sepia {
            background: #f4ecd8;
        }

        .theme-sepia #content {
            color: #5c4a2f;
        }

        .theme-dark {
            background: #1a1a1a;
        }

        .theme-dark #content {
            color: #e0e0e0;
        }

        .theme-dark .reader-controls {
            background: #2d2d2d;
            border-color: #444;
        }

        .theme-dark .control-btn {
            background: #3d3d3d;
            border-color: #555;
            color: #e0e0e0;
        }

        /* æ­¡è¿ç•«é¢ */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #999;
        }

        .welcome-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .welcome h2 {
            margin-bottom: 15px;
            color: #666;
        }

        .welcome-upload {
            margin-top: 30px;
        }

        .welcome-upload-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .welcome-upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: 0;
                top: 70px;
                height: calc(100% - 70px);
                z-index: 100;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }

            .toolbar h1 {
                font-size: 18px;
            }

            .reader-content {
                padding: 20px;
            }

            #content {
                font-size: 16px;
            }
        }

        /* æ»¾å‹•æ¢ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .empty-message {
            text-align: center;
            color: #999;
            padding: 30px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é ‚éƒ¨å·¥å…·æ¬„ -->
        <div class="toolbar">
            <div class="toolbar-left">
                <h1>ğŸ“š EPUB é–±è®€å™¨</h1>
                <button class="btn" onclick="openFile()">
                    ğŸ“ æ‰“é–‹æ–‡ä»¶
                </button>
                <button class="btn" onclick="toggleSidebar()">
                    â˜° ç›®éŒ„
                </button>
            </div>
            <div class="toolbar-right">
                <button class="btn" onclick="addBookmark()">
                    â­ æ·»åŠ æ›¸ç±¤
                </button>
                <button class="btn" onclick="downloadBook()">
                    ğŸ’¾ ä¸‹è¼‰
                </button>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".epub" onchange="loadEpub(event)">
        </div>

        <!-- ä¸»å…§å®¹å€åŸŸ -->
        <div class="main-content">
            <!-- å´é‚Šæ¬„ -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" onclick="switchTab('toc')">ç›®éŒ„</button>
                    <button class="sidebar-tab" onclick="switchTab('bookmarks')">æ›¸ç±¤</button>
                    <button class="sidebar-tab" onclick="switchTab('search')">æœç´¢</button>
                </div>
                <div class="sidebar-content">
                    <!-- ç›®éŒ„ -->
                    <div id="toc-panel" class="tab-panel">
                        <div id="toc-list"></div>
                    </div>
                    <!-- æ›¸ç±¤ -->
                    <div id="bookmarks-panel" class="tab-panel" style="display:none;">
                        <div id="bookmarks-list"></div>
                    </div>
                    <!-- æœç´¢ -->
                    <div id="search-panel" class="tab-panel" style="display:none;">
                        <div class="search-box">
                            <input type="text" class="search-input" id="searchInput" placeholder="è¼¸å…¥æœç´¢å…§å®¹...">
                            <button class="control-btn" onclick="searchInBook()">ğŸ”</button>
                        </div>
                        <div id="search-results"></div>
                    </div>
                </div>
            </div>

            <!-- é–±è®€å€åŸŸ -->
            <div class="reader-area theme-light" id="readerArea">
                <div class="reader-controls">
                    <div class="control-group">
                        <button class="control-btn" onclick="previousChapter()">â¬…ï¸ ä¸Šä¸€ç« </button>
                        <button class="control-btn" onclick="nextChapter()">ä¸‹ä¸€ç«  â¡ï¸</button>
                    </div>
                    
                    <div class="control-group">
                        <div class="font-size-control">
                            <span style="font-size: 12px; color: #666;">å­—é«”å¤§å°ï¼š</span>
                            <button class="font-size-btn" onclick="decreaseFontSize()">A-</button>
                            <span id="fontSizeDisplay" style="font-size: 14px; color: #666;">18px</span>
                            <button class="font-size-btn" onclick="increaseFontSize()">A+</button>
                        </div>
                        
                        <select class="theme-selector" id="themeSelector" onchange="changeTheme()">
                            <option value="light">æ·ºè‰²ä¸»é¡Œ</option>
                            <option value="sepia">è­·çœ¼ä¸»é¡Œ</option>
                            <option value="dark">æ·±è‰²ä¸»é¡Œ</option>
                        </select>
                    </div>
                </div>

                <div class="reader-content" id="readerContent">
                    <div class="welcome" id="welcome">
                        <div class="welcome-icon">ğŸ“–</div>
                        <h2>æ­¡è¿ä½¿ç”¨ EPUB é–±è®€å™¨</h2>
                        <p>è«‹é¸æ“‡ä¸€å€‹ EPUB æ–‡ä»¶é–‹å§‹é–±è®€</p>
                        <div class="welcome-upload">
                            <button class="welcome-upload-btn" onclick="openFile()">
                                é¸æ“‡æ–‡ä»¶
                            </button>
                        </div>
                    </div>
                    <div id="content" style="display:none;"></div>
                </div>

                <div class="progress-bar">
                    <div class="progress-track" onclick="seekToPosition(event)">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥å‹•ç•« -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- JSZip åº«ç”¨æ–¼è§£å£“ EPUB -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // å…¨å±€è®Šé‡
        let currentBook = null;
        let currentChapter = 0;
        let chapters = [];
        let bookmarks = [];
        let fontSize = 18;
        let tocData = [];
        let bookContent = {};

        // å¾localStorageåŠ è¼‰æ•¸æ“š
        function loadFromStorage() {
            const saved = localStorage.getItem('epubReaderData');
            if (saved) {
                const data = JSON.parse(saved);
                bookmarks = data.bookmarks || [];
                fontSize = data.fontSize || 18;
                updateFontSize();
            }
        }

        // ä¿å­˜åˆ°localStorage
        function saveToStorage() {
            const data = {
                bookmarks: bookmarks,
                fontSize: fontSize,
                currentChapter: currentChapter
            };
            localStorage.setItem('epubReaderData', JSON.stringify(data));
        }

        // æ‰“é–‹æ–‡ä»¶é¸æ“‡å™¨
        function openFile() {
            document.getElementById('fileInput').click();
        }

        // è¼‰å…¥EPUBæ–‡ä»¶
        async function loadEpub(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading(true);
            
            try {
                const zip = new JSZip();
                const content = await file.arrayBuffer();
                currentBook = await zip.loadAsync(content);
                
                // è§£æEPUBçµæ§‹
                await parseEpub();
                
                // é¡¯ç¤ºç¬¬ä¸€ç« 
                await displayChapter(0);
                
                // éš±è—æ­¡è¿é é¢
                document.getElementById('welcome').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                showLoading(false);
                
            } catch (error) {
                console.error('è¼‰å…¥EPUBå¤±æ•—:', error);
                alert('è¼‰å…¥æ–‡ä»¶å¤±æ•—ï¼Œè«‹ç¢ºä¿é€™æ˜¯æœ‰æ•ˆçš„EPUBæ–‡ä»¶');
                showLoading(false);
            }
        }

        // è§£æEPUBçµæ§‹
        async function parseEpub() {
            try {
                // è®€å–container.xml
                const containerXml = await currentBook.file('META-INF/container.xml').async('text');
                const parser = new DOMParser();
                const containerDoc = parser.parseFromString(containerXml, 'text/xml');
                const contentPath = containerDoc.querySelector('rootfile').getAttribute('full-path');
                
                // è®€å–content.opf
                const contentOpf = await currentBook.file(contentPath).async('text');
                const opfDoc = parser.parseFromString(contentOpf, 'text/xml');
                
                // ç²å–åŸºç¤è·¯å¾‘
                const basePath = contentPath.substring(0, contentPath.lastIndexOf('/') + 1);
                
                // è§£æspine (ç« ç¯€é †åº)
                const spineItems = opfDoc.querySelectorAll('spine itemref');
                const manifest = opfDoc.querySelectorAll('manifest item');
                
                chapters = [];
                for (let item of spineItems) {
                    const idref = item.getAttribute('idref');
                    const manifestItem = Array.from(manifest).find(m => m.getAttribute('id') === idref);
                    if (manifestItem) {
                        const href = manifestItem.getAttribute('href');
                        chapters.push(basePath + href);
                    }
                }
                
                // è§£æç›®éŒ„ (toc.ncx æˆ– nav.xhtml)
                await parseToc(opfDoc, basePath);
                
                // è¼‰å…¥æ‰€æœ‰ç« ç¯€å…§å®¹ç”¨æ–¼æœç´¢
                await loadAllChapters();
                
            } catch (error) {
                console.error('è§£æEPUBçµæ§‹å¤±æ•—:', error);
            }
        }

        // è§£æç›®éŒ„
        async function parseToc(opfDoc, basePath) {
            try {
                // å˜—è©¦æŸ¥æ‰¾toc.ncx
                const tocItem = opfDoc.querySelector('manifest item[id="ncx"], manifest item[media-type="application/x-dtbncx+xml"]');
                
                if (tocItem) {
                    const tocPath = basePath + tocItem.getAttribute('href');
                    const tocXml = await currentBook.file(tocPath).async('text');
                    const parser = new DOMParser();
                    const tocDoc = parser.parseFromString(tocXml, 'text/xml');
                    
                    const navPoints = tocDoc.querySelectorAll('navPoint');
                    tocData = [];
                    
                    navPoints.forEach((navPoint, index) => {
                        const label = navPoint.querySelector('text')?.textContent || `ç« ç¯€ ${index + 1}`;
                        const src = navPoint.querySelector('content')?.getAttribute('src') || '';
                        const playOrder = navPoint.getAttribute('playOrder') || index;
                        
                        tocData.push({
                            label: label,
                            src: basePath + src.split('#')[0],
                            order: parseInt(playOrder)
                        });
                    });
                }
                
                // å¦‚æœæ²’æœ‰æ‰¾åˆ°ç›®éŒ„ï¼Œä½¿ç”¨ç« ç¯€åˆ—è¡¨
                if (tocData.length === 0) {
                    tocData = chapters.map((chapter, index) => ({
                        label: `ç« ç¯€ ${index + 1}`,
                        src: chapter,
                        order: index
                    }));
                }
                
                renderToc();
                
            } catch (error) {
                console.error('è§£æç›®éŒ„å¤±æ•—:', error);
                // ä½¿ç”¨é»˜èªç›®éŒ„
                tocData = chapters.map((chapter, index) => ({
                    label: `ç« ç¯€ ${index + 1}`,
                    src: chapter,
                    order: index
                }));
                renderToc();
            }
        }

        // æ¸²æŸ“ç›®éŒ„
        function renderToc() {
            const tocList = document.getElementById('toc-list');
            if (tocData.length === 0) {
                tocList.innerHTML = '<div class="empty-message">æš«ç„¡ç›®éŒ„</div>';
                return;
            }
            
            tocList.innerHTML = '';
            tocData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'toc-item';
                div.textContent = item.label;
                div.onclick = () => {
                    const chapterIndex = chapters.findIndex(c => c === item.src);
                    if (chapterIndex !== -1) {
                        displayChapter(chapterIndex);
                    }
                };
                tocList.appendChild(div);
            });
        }

        // è¼‰å…¥æ‰€æœ‰ç« ç¯€å…§å®¹
        async function loadAllChapters() {
            bookContent = {};
            for (let i = 0; i < chapters.length; i++) {
                try {
                    const content = await currentBook.file(chapters[i]).async('text');
                    bookContent[i] = content;
                } catch (error) {
                    console.error(`è¼‰å…¥ç« ç¯€ ${i} å¤±æ•—:`, error);
                }
            }
        }

        // é¡¯ç¤ºç« ç¯€
        async function displayChapter(index) {
            if (index < 0 || index >= chapters.length) return;
            
            currentChapter = index;
            showLoading(true);
            
            try {
                let html = bookContent[index];
                if (!html) {
                    html = await currentBook.file(chapters[index]).async('text');
                }
                
                // è™•ç†ç›¸å°è·¯å¾‘çš„åœ–ç‰‡å’Œæ¨£å¼
                const basePath = chapters[index].substring(0, chapters[index].lastIndexOf('/') + 1);
                html = await processHtml(html, basePath);
                
                const contentDiv = document.getElementById('content');
                contentDiv.innerHTML = html;
                
                // æ»¾å‹•åˆ°é ‚éƒ¨
                document.getElementById('readerContent').scrollTop = 0;
                
                // æ›´æ–°é€²åº¦
                updateProgress();
                
                showLoading(false);
                saveToStorage();
                
            } catch (error) {
                console.error('é¡¯ç¤ºç« ç¯€å¤±æ•—:', error);
                showLoading(false);
            }
        }

        // è™•ç†HTMLå…§å®¹
        async function processHtml(html, basePath) {
            // æå–bodyå…§å®¹
            const bodyMatch = html.match(/<body[^>]*>([\s\S]*)<\/body>/i);
            if (bodyMatch) {
                html = bodyMatch[1];
            }
            
            // è™•ç†åœ–ç‰‡è·¯å¾‘
            html = html.replace(/src="([^"]+)"/g, (match, src) => {
                if (src.startsWith('http')) return match;
                const imgPath = basePath + src;
                return `src="${imgPath}" data-original="${imgPath}"`;
            });
            
            // è¼‰å…¥åœ–ç‰‡
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const images = tempDiv.querySelectorAll('img[data-original]');
            
            for (let img of images) {
                const imgPath = img.getAttribute('data-original');
                try {
                    const imgData = await currentBook.file(imgPath).async('base64');
                    const ext = imgPath.split('.').pop().toLowerCase();
                    const mimeType = {
                        'jpg': 'image/jpeg',
                        'jpeg': 'image/jpeg',
                        'png': 'image/png',
                        'gif': 'image/gif',
                        'svg': 'image/svg+xml'
                    }[ext] || 'image/jpeg';
                    
                    img.src = `data:${mimeType};base64,${imgData}`;
                } catch (error) {
                    console.error('è¼‰å…¥åœ–ç‰‡å¤±æ•—:', imgPath, error);
                }
            }
            
            return tempDiv.innerHTML;
        }

        // ä¸Šä¸€ç« 
        function previousChapter() {
            if (currentChapter > 0) {
                displayChapter(currentChapter - 1);
            } else {
                alert('å·²ç¶“æ˜¯ç¬¬ä¸€ç« äº†');
            }
        }

        // ä¸‹ä¸€ç« 
        function nextChapter() {
            if (currentChapter < chapters.length - 1) {
                displayChapter(currentChapter + 1);
            } else {
                alert('å·²ç¶“æ˜¯æœ€å¾Œä¸€ç« äº†');
            }
        }

        // å¢åŠ å­—é«”å¤§å°
        function increaseFontSize() {
            if (fontSize < 30) {
                fontSize += 2;
                updateFontSize();
                saveToStorage();
            }
        }

        // æ¸›å°‘å­—é«”å¤§å°
        function decreaseFontSize() {
            if (fontSize > 12) {
                fontSize -= 2;
                updateFontSize();
                saveToStorage();
            }
        }

        // æ›´æ–°å­—é«”å¤§å°
        function updateFontSize() {
            document.getElementById('content').style.fontSize = fontSize + 'px';
            document.getElementById('fontSizeDisplay').textContent = fontSize + 'px';
        }

        // åˆ‡æ›ä¸»é¡Œ
        function changeTheme() {            const theme = document.getElementById('themeSelector').value;
            const readerArea = document.getElementById('readerArea');
            
            readerArea.className = 'reader-area theme-' + theme;
            localStorage.setItem('epubTheme', theme);
        }

        // åˆ‡æ›å´é‚Šæ¬„
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
        }

        // åˆ‡æ›æ¨™ç±¤é 
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰æ¨™ç±¤é 
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.style.display = 'none';
            });
            
            // ç§»é™¤æ‰€æœ‰æ´»å‹•ç‹€æ…‹
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„æ¨™ç±¤é 
            document.getElementById(tabName + '-panel').style.display = 'block';
            event.target.classList.add('active');
        }

        // æ·»åŠ æ›¸ç±¤
        function addBookmark() {
            if (!currentBook || chapters.length === 0) {
                alert('è«‹å…ˆæ‰“é–‹ä¸€æœ¬æ›¸');
                return;
            }
            
            const content = document.getElementById('content');
            const selection = window.getSelection();
            let selectedText = selection.toString().trim();
            
            if (!selectedText) {
                selectedText = content.textContent.substring(0, 100) + '...';
            }
            
            const bookmark = {
                id: Date.now(),
                chapter: currentChapter,
                chapterTitle: tocData[currentChapter]?.label || `ç« ç¯€ ${currentChapter + 1}`,
                text: selectedText,
                time: new Date().toLocaleString('zh-TW'),
                scrollPosition: document.getElementById('readerContent').scrollTop
            };
            
            bookmarks.unshift(bookmark);
            saveToStorage();
            renderBookmarks();
            
            alert('æ›¸ç±¤å·²æ·»åŠ ï¼');
        }

        // æ¸²æŸ“æ›¸ç±¤åˆ—è¡¨
        function renderBookmarks() {
            const bookmarksList = document.getElementById('bookmarks-list');
            
            if (bookmarks.length === 0) {
                bookmarksList.innerHTML = '<div class="empty-message">æš«ç„¡æ›¸ç±¤</div>';
                return;
            }
            
            bookmarksList.innerHTML = '';
            bookmarks.forEach(bookmark => {
                const div = document.createElement('div');
                div.className = 'bookmark-item';
                div.innerHTML = `
                    <button class="bookmark-delete" onclick="deleteBookmark(${bookmark.id}); event.stopPropagation();">åˆªé™¤</button>
                    <div class="bookmark-title">${bookmark.chapterTitle}</div>
                    <div class="bookmark-text">${bookmark.text}</div>
                    <div class="bookmark-time">${bookmark.time}</div>
                `;
                div.onclick = () => {
                    displayChapter(bookmark.chapter);
                    setTimeout(() => {
                        document.getElementById('readerContent').scrollTop = bookmark.scrollPosition;
                    }, 100);
                };
                bookmarksList.appendChild(div);
            });
        }

        // åˆªé™¤æ›¸ç±¤
        function deleteBookmark(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æ›¸ç±¤å—ï¼Ÿ')) {
                bookmarks = bookmarks.filter(b => b.id !== id);
                saveToStorage();
                renderBookmarks();
            }
        }

        // åœ¨æ›¸ä¸­æœç´¢
        function searchInBook() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('search-results');
            const query = searchInput.value.trim();
            
            if (!query) {
                alert('è«‹è¼¸å…¥æœç´¢å…§å®¹');
                return;
            }
            
            if (Object.keys(bookContent).length === 0) {
                alert('è«‹å…ˆæ‰“é–‹ä¸€æœ¬æ›¸');
                return;
            }
            
            searchResults.innerHTML = '<div class="empty-message">æœç´¢ä¸­...</div>';
            
            setTimeout(() => {
                const results = [];
                const queryLower = query.toLowerCase();
                
                for (let i = 0; i < chapters.length; i++) {
                    if (!bookContent[i]) continue;
                    
                    // ç§»é™¤HTMLæ¨™ç±¤
                    const text = bookContent[i].replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ');
                    const textLower = text.toLowerCase();
                    
                    let index = 0;
                    while ((index = textLower.indexOf(queryLower, index)) !== -1) {
                        const start = Math.max(0, index - 50);
                        const end = Math.min(text.length, index + query.length + 50);
                        let snippet = text.substring(start, end);
                        
                        // æ·»åŠ çœç•¥è™Ÿ
                        if (start > 0) snippet = '...' + snippet;
                        if (end < text.length) snippet = snippet + '...';
                        
                        results.push({
                            chapter: i,
                            chapterTitle: tocData[i]?.label || `ç« ç¯€ ${i + 1}`,
                            snippet: snippet,
                            position: index
                        });
                        
                        index += query.length;
                        
                        // é™åˆ¶æ¯ç« æœ€å¤š5å€‹çµæœ
                        if (results.filter(r => r.chapter === i).length >= 5) break;
                    }
                    
                    // é™åˆ¶ç¸½çµæœæ•¸
                    if (results.length >= 50) break;
                }
                
                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="empty-message">æ²’æœ‰æ‰¾åˆ°ç›¸é—œå…§å®¹</div>';
                    return;
                }
                
                searchResults.innerHTML = '';
                results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = 'search-result';
                    
                    // é«˜äº®æœç´¢è©
                    const highlightedSnippet = result.snippet.replace(
                        new RegExp(query, 'gi'),
                        match => `<mark>${match}</mark>`
                    );
                    
                    div.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 5px; color: #667eea;">
                            ${result.chapterTitle}
                        </div>
                        <div class="search-result-text">${highlightedSnippet}</div>
                    `;
                    
                    div.onclick = () => {
                        displayChapter(result.chapter);
                        // å˜—è©¦æ»¾å‹•åˆ°æœç´¢ä½ç½®
                        setTimeout(() => {
                            const contentDiv = document.getElementById('content');
                            const textContent = contentDiv.textContent;
                            const index = textContent.toLowerCase().indexOf(query.toLowerCase());
                            if (index !== -1) {
                                // ç°¡å–®çš„æ»¾å‹•ä¼°ç®—
                                const scrollRatio = index / textContent.length;
                                const maxScroll = document.getElementById('readerContent').scrollHeight;
                                document.getElementById('readerContent').scrollTop = maxScroll * scrollRatio;
                            }
                        }, 100);
                    };
                    
                    searchResults.appendChild(div);
                });
                
                // é¡¯ç¤ºçµæœæ•¸é‡
                const countDiv = document.createElement('div');
                countDiv.style.cssText = 'padding: 10px; background: #e3f2fd; border-radius: 8px; margin-bottom: 10px; text-align: center; font-weight: bold; color: #1976d2;';
                countDiv.textContent = `æ‰¾åˆ° ${results.length} å€‹çµæœ`;
                searchResults.insertBefore(countDiv, searchResults.firstChild);
                
            }, 100);
        }

        // æœç´¢æ¡†å›è»Šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchInBook();
                    }
                });
            }
        });

        // æ›´æ–°é€²åº¦
        function updateProgress() {
            const progress = ((currentChapter + 1) / chapters.length * 100).toFixed(1);
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = 
                `${currentChapter + 1}/${chapters.length} (${progress}%)`;
        }

        // é»æ“Šé€²åº¦æ¢è·³è½‰
        function seekToPosition(event) {
            if (chapters.length === 0) return;
            
            const progressTrack = event.currentTarget;
            const rect = progressTrack.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const percentage = x / rect.width;
            const targetChapter = Math.floor(percentage * chapters.length);
            
            displayChapter(targetChapter);
        }

        // é¡¯ç¤º/éš±è—è¼‰å…¥å‹•ç•«
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('active');
            } else {
                loading.classList.remove('active');
            }
        }

        // ä¸‹è¼‰ç•¶å‰æ›¸ç±
        function downloadBook() {
            if (!currentBook) {
                alert('è«‹å…ˆæ‰“é–‹ä¸€æœ¬æ›¸');
                return;
            }
            
            alert('ä¸‹è¼‰åŠŸèƒ½ï¼šåŸå§‹EPUBæ–‡ä»¶å·²åœ¨æ‚¨çš„è¨­å‚™ä¸Š\nå¦‚éœ€ä¿å­˜é–±è®€é€²åº¦å’Œæ›¸ç±¤ï¼Œè«‹ä½¿ç”¨ç€è¦½å™¨çš„æ›¸ç±¤åŠŸèƒ½');
        }

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            // å·¦ç®­é ­ - ä¸Šä¸€ç« 
            if (e.key === 'ArrowLeft' && !e.target.matches('input, textarea')) {
                previousChapter();
            }
            // å³ç®­é ­ - ä¸‹ä¸€ç« 
            if (e.key === 'ArrowRight' && !e.target.matches('input, textarea')) {
                nextChapter();
            }
            // Ctrl+F - æœç´¢
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                switchTab('search');
                document.getElementById('searchInput').focus();
            }
            // Ctrl+B - æ·»åŠ æ›¸ç±¤
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                addBookmark();
            }
            // Ctrl+O - æ‰“é–‹æ–‡ä»¶
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                openFile();
            }
        });

        // ç›£è½æ»¾å‹•äº‹ä»¶ï¼Œè‡ªå‹•ä¿å­˜é–±è®€ä½ç½®
        let scrollTimeout;
        document.getElementById('readerContent').addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                const scrollData = {
                    chapter: currentChapter,
                    scrollTop: this.scrollTop,
                    timestamp: Date.now()
                };
                localStorage.setItem('epubScrollPosition', JSON.stringify(scrollData));
            }, 500);
        });

        // æ¢å¾©ä¸Šæ¬¡é–±è®€ä½ç½®
        function restoreReadingPosition() {
            const savedPosition = localStorage.getItem('epubScrollPosition');
            if (savedPosition) {
                try {
                    const data = JSON.parse(savedPosition);
                    // å¦‚æœæ˜¯åœ¨24å°æ™‚å…§çš„é–±è®€è¨˜éŒ„ï¼Œæ¢å¾©ä½ç½®
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        if (data.chapter === currentChapter) {
                            setTimeout(() => {
                                document.getElementById('readerContent').scrollTop = data.scrollTop;
                            }, 100);
                        }
                    }
                } catch (e) {
                    console.error('æ¢å¾©é–±è®€ä½ç½®å¤±æ•—:', e);
                }
            }
        }

        // é é¢åŠ è¼‰æ™‚åˆå§‹åŒ–
        window.addEventListener('load', function() {
            loadFromStorage();
            renderBookmarks();
            
            // æ¢å¾©ä¸»é¡Œè¨­ç½®
            const savedTheme = localStorage.getItem('epubTheme');
            if (savedTheme) {
                document.getElementById('themeSelector').value = savedTheme;
                changeTheme();
            }
            
            // æ·»åŠ æ‹–æ”¾æ–‡ä»¶æ”¯æŒ
            const container = document.querySelector('.container');
            
            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.opacity = '0.7';
            });
            
            container.addEventListener('dragleave', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.opacity = '1';
            });
            
            container.addEventListener('drop', function(e) {
                e.preventDefault();
                e.stopPropagation();
                this.style.opacity = '1';
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.epub')) {
                    const fileInput = document.getElementById('fileInput');
                    fileInput.files = files;
                    loadEpub({ target: fileInput });
                } else {
                    alert('è«‹æ‹–æ”¾ä¸€å€‹ .epub æ–‡ä»¶');
                }
            });

            // é˜²æ­¢é é¢åˆ·æ–°æ™‚çš„æ•¸æ“šä¸Ÿå¤±æç¤º
            window.addEventListener('beforeunload', function(e) {
                if (currentBook) {
                    saveToStorage();
                }
            });
        });

        // è§¸æ‘¸æ‰‹å‹¢æ”¯æŒï¼ˆç§»å‹•è¨­å‚™ï¼‰
        let touchStartX = 0;
        let touchEndX = 0;

        document.getElementById('readerContent').addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        }, false);

        document.getElementById('readerContent').addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);

        function handleSwipe() {
            const swipeThreshold = 100;
            const diff = touchStartX - touchEndX;
            
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // å‘å·¦æ»‘å‹• - ä¸‹ä¸€ç« 
                    nextChapter();
                } else {
                    // å‘å³æ»‘å‹• - ä¸Šä¸€ç« 
                    previousChapter();
                }
            }
        }

        // è‡ªå‹•ä¿å­˜åŠŸèƒ½
        setInterval(function() {
            if (currentBook) {
                saveToStorage();
            }
        }, 30000); // æ¯30ç§’è‡ªå‹•ä¿å­˜ä¸€æ¬¡

        // å·¥å…·æç¤º
        console.log('%cğŸ“š EPUB é–±è®€å™¨å·²å°±ç·’', 'color: #667eea; font-size: 16px; font-weight: bold;');
        console.log('%cå¿«æ·éµæç¤º:', 'color: #764ba2; font-size: 14px; font-weight: bold;');
        console.log('â† â†’ : ä¸Šä¸€ç« /ä¸‹ä¸€ç« ');
        console.log('Ctrl+F : æœç´¢');
        console.log('Ctrl+B : æ·»åŠ æ›¸ç±¤');
        console.log('Ctrl+O : æ‰“é–‹æ–‡ä»¶');
        console.log('ç§»å‹•è¨­å‚™å¯ä½¿ç”¨å·¦å³æ»‘å‹•æ‰‹å‹¢ç¿»é ');

        // æ·»åŠ å…¨å±åŠŸèƒ½
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('ç„¡æ³•é€²å…¥å…¨å±æ¨¡å¼:', err);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // å°å‡ºç­†è¨˜åŠŸèƒ½
        function exportNotes() {
            if (bookmarks.length === 0) {
                alert('æ²’æœ‰å¯å°å‡ºçš„æ›¸ç±¤');
                return;
            }

            let notesText = '=== EPUB é–±è®€ç­†è¨˜ ===\n\n';
            notesText += `å°å‡ºæ™‚é–“: ${new Date().toLocaleString('zh-TW')}\n`;
            notesText += `æ›¸ç±¤æ•¸é‡: ${bookmarks.length}\n\n`;
            notesText += '='.repeat(50) + '\n\n';

            bookmarks.forEach((bookmark, index) => {
                notesText += `ã€æ›¸ç±¤ ${index + 1}ã€‘\n`;
                notesText += `ç« ç¯€: ${bookmark.chapterTitle}\n`;
                notesText += `æ™‚é–“: ${bookmark.time}\n`;
                notesText += `å…§å®¹: ${bookmark.text}\n`;
                notesText += '\n' + '-'.repeat(50) + '\n\n';
            });

            // å‰µå»ºä¸‹è¼‰éˆæ¥
            const blob = new Blob([notesText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `é–±è®€ç­†è¨˜_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('ç­†è¨˜å·²å°å‡ºï¼');
        }

        // çµ±è¨ˆåŠŸèƒ½
        function showStatistics() {
            if (!currentBook || chapters.length === 0) {
                alert('è«‹å…ˆæ‰“é–‹ä¸€æœ¬æ›¸');
                return;
            }

            let totalWords = 0;
            let totalChars = 0;

            for (let i = 0; i < chapters.length; i++) {
                if (bookContent[i]) {
                    const text = bookContent[i].replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
                    totalChars += text.length;
                    totalWords += text.split(/\s+/).length;
                }
            }

            const readingSpeed = 300; // æ¯åˆ†é˜300å­—
            const estimatedTime = Math.ceil(totalWords / readingSpeed);
            const hours = Math.floor(estimatedTime / 60);
            const minutes = estimatedTime % 60;

            const stats = `
ğŸ“Š æ›¸ç±çµ±è¨ˆä¿¡æ¯

ğŸ“– ç¸½ç« ç¯€æ•¸: ${chapters.length}
ğŸ“ ç¸½å­—æ•¸: ${totalWords.toLocaleString()} å­—
ğŸ“„ ç¸½å­—ç¬¦æ•¸: ${totalChars.toLocaleString()} å€‹
â±ï¸ é è¨ˆé–±è®€æ™‚é–“: ${hours}å°æ™‚${minutes}åˆ†é˜
ğŸ“ ç•¶å‰é€²åº¦: ${((currentChapter + 1) / chapters.length * 100).toFixed(1)}%
â­ æ›¸ç±¤æ•¸é‡: ${bookmarks.length}
            `.trim();

            alert(stats);
        }

        // é–±è®€æ¨¡å¼ï¼ˆéš±è—UIï¼‰
        let isReadingMode = false;
        function toggleReadingMode() {
            isReadingMode = !isReadingMode;
            const toolbar = document.querySelector('.toolbar');
            const sidebar = document.getElementById('sidebar');
            const controls = document.querySelector('.reader-controls');
            const progressBar = document.querySelector('.progress-bar');

            if (isReadingMode) {
                toolbar.style.display = 'none';
                sidebar.style.display = 'none';
                controls.style.display = 'none';
                progressBar.style.display = 'none';
                document.getElementById('readerArea').style.height = '100vh';
            } else {
                toolbar.style.display = 'flex';
                sidebar.style.display = 'flex';
                controls.style.display = 'flex';
                progressBar.style.display = 'flex';
                document.getElementById('readerArea').style.height = 'auto';
            }
        }

        // å¿«é€Ÿè·³è½‰åˆ°æŒ‡å®šç« ç¯€
        function jumpToChapter() {
            if (chapters.length === 0) {
                alert('è«‹å…ˆæ‰“é–‹ä¸€æœ¬æ›¸');
                return;
            }

            const chapterNum = prompt(`è«‹è¼¸å…¥ç« ç¯€è™Ÿ (1-${chapters.length}):`);
            if (chapterNum) {
                const num = parseInt(chapterNum);
                if (num >= 1 && num <= chapters.length) {
                    displayChapter(num - 1);
                } else {
                    alert('ç„¡æ•ˆçš„ç« ç¯€è™Ÿ');
                }
            }
        }

        // æ–‡å­—é¸æ“‡å·¥å…·
        document.getElementById('content').addEventListener('mouseup', function() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText && selectedText.length > 0) {
                // å¯ä»¥åœ¨é€™è£¡æ·»åŠ æ›´å¤šåŠŸèƒ½ï¼Œæ¯”å¦‚åŠƒç·šã€ç­†è¨˜ç­‰
                console.log('é¸ä¸­æ–‡å­—:', selectedText);
            }
        });

        // æ·»åŠ è¡Œé–“è·èª¿æ•´åŠŸèƒ½
        let lineHeight = 1.8;
        function increaseLineHeight() {
            if (lineHeight < 3) {
                lineHeight += 0.2;
                document.getElementById('content').style.lineHeight = lineHeight;
                localStorage.setItem('epubLineHeight', lineHeight);
            }
        }

        function decreaseLineHeight() {
            if (lineHeight > 1.2) {
                lineHeight -= 0.2;
                document.getElementById('content').style.lineHeight = lineHeight;
                localStorage.setItem('epubLineHeight', lineHeight);
            }
        }

        // æ¢å¾©è¡Œé–“è·è¨­ç½®
        const savedLineHeight = localStorage.getItem('epubLineHeight');
        if (savedLineHeight) {
            lineHeight = parseFloat(savedLineHeight);
            document.getElementById('content').style.lineHeight = lineHeight;
        }

        // å¤œé–“æ¨¡å¼è‡ªå‹•åˆ‡æ›
        function autoNightMode() {
            const hour = new Date().getHours();
            if (hour >= 22 || hour < 6) {
                document.getElementById('themeSelector').value = 'dark';
                changeTheme();
            }
        }

        // æ·»åŠ è­·çœ¼æé†’
        let readingStartTime = null;
        let readingTimer = null;

        function startReadingTimer() {
            if (readingTimer) return;
            
            readingStartTime = Date.now();
            readingTimer = setInterval(() => {
                const elapsed = Date.now() - readingStartTime;
                const minutes = Math.floor(elapsed / 60000);
                
                // æ¯30åˆ†é˜æé†’ä¸€æ¬¡
                if (minutes > 0 && minutes % 30 === 0) {
                    if (confirm('æ‚¨å·²ç¶“é€£çºŒé–±è®€30åˆ†é˜äº†ï¼Œè¦ä¼‘æ¯ä¸€ä¸‹å—ï¼Ÿ')) {
                        pauseReading();
                    }
                }
            }, 60000); // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡
        }

        function pauseReading() {
            if (readingTimer) {
                clearInterval(readingTimer);
                readingTimer = null;
                readingStartTime = null;
            }
        }

        // ç•¶æ‰“é–‹æ›¸ç±æ™‚é–‹å§‹è¨ˆæ™‚
        const originalDisplayChapter = displayChapter;
        displayChapter = async function(index) {
            await originalDisplayChapter(index);
            startReadingTimer();
        };

        // é é¢å¤±å»ç„¦é»æ™‚æš«åœè¨ˆæ™‚
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                pauseReading();
            } else if (currentBook) {
                startReadingTimer();
            }
        });

        // æ·»åŠ æ–‡æœ¬å°é½Šæ–¹å¼åˆ‡æ›
        let textAlign = 'justify';
        function toggleTextAlign() {
            const alignments = ['justify', 'left', 'center'];
            const currentIndex = alignments.indexOf(textAlign);
            textAlign = alignments[(currentIndex + 1) % alignments.length];
            document.getElementById('content').style.textAlign = textAlign;
            localStorage.setItem('epubTextAlign', textAlign);
        }

        // æ¢å¾©æ–‡æœ¬å°é½Šè¨­ç½®
        const savedTextAlign = localStorage.getItem('epubTextAlign');
        if (savedTextAlign) {
            textAlign = savedTextAlign;
            document.getElementById('content').style.textAlign = textAlign;
        }

        // æ¸…é™¤æ‰€æœ‰æ•¸æ“š
        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰é–±è®€æ•¸æ“šå—ï¼Ÿ\né€™å°‡åˆªé™¤æ‰€æœ‰æ›¸ç±¤å’Œè¨­ç½®')) {
                localStorage.clear();
                bookmarks = [];
                renderBookmarks();
                alert('æ‰€æœ‰æ•¸æ“šå·²æ¸…é™¤');
            }
        }

        // æ·»åŠ å³éµèœå–®
        document.getElementById('content').addEventListener('contextmenu', function(e) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (selectedText) {
                e.preventDefault();
                
                // é€™è£¡å¯ä»¥é¡¯ç¤ºè‡ªå®šç¾©å³éµèœå–®
                const options = [
                    'æ·»åŠ æ›¸ç±¤',
                    'è¤‡è£½æ–‡å­—',
                    'æœç´¢æ­¤æ–‡å­—'
                ];
                
                console.log('å³éµé¸ä¸­:', selectedText);
            }
        });

        // æ€§èƒ½å„ªåŒ–ï¼šè™›æ“¬æ»¾å‹•ï¼ˆé‡å°è¶…é•·å…§å®¹ï¼‰
        function optimizeContent() {
            const content = document.getElementById('content');
            const maxHeight = 500000; // æœ€å¤§å…§å®¹é«˜åº¦
            
            if (content.scrollHeight > maxHeight) {
                console.log('å…§å®¹éé•·ï¼Œå•Ÿç”¨å„ªåŒ–æ¨¡å¼');
                // å¯ä»¥å¯¦ç¾åˆ†æ®µåŠ è¼‰
            }
        }

        // æ·»åŠ èªéŸ³æœ—è®€åŠŸèƒ½ï¼ˆå¦‚æœç€è¦½å™¨æ”¯æŒï¼‰
        function startSpeech() {
            if ('speechSynthesis' in window) {
                const text = document.getElementById('content').textContent;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-TW';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                
                speechSynthesis.speak(utterance);
                alert('é–‹å§‹èªéŸ³æœ—è®€');
            } else {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³æœ—è®€åŠŸèƒ½');
            }
        }

        function stopSpeech() {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
            }
        }

        // æ·»åŠ æ‰“å°åŠŸèƒ½
        function printCurrentChapter() {
            if (!currentBook) {
                alert('è«‹å…ˆæ‰“é–‹ä¸€æœ¬æ›¸');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const content = document.getElementById('content').innerHTML;
            const chapterTitle = tocData[currentChapter]?.label || `ç« ç¯€ ${currentChapter + 1}`;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${chapterTitle}</title>
                    <style>
                        body {
                            font-family: 'Microsoft JhengHei', Arial, sans-serif;
                            line-height: 1.8;
                            padding: 40px;
                            max-width: 800px;
                            margin: 0 auto;
                        }
                        h1, h2, h3 { margin: 20px 0; }
                        p { margin: 15px 0; }
                        img { max-width: 100%; }
                    </style>
                </head>
                <body>
                    <h1>${chapterTitle}</h1>
                    ${content}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        // éŒ¯èª¤è™•ç†å’Œæ—¥èªŒ
        window.addEventListener('error', function(e) {
            console.error('ç™¼ç”ŸéŒ¯èª¤:', e.error);
        });

        // åˆå§‹åŒ–å®Œæˆæç¤º
        console.log('%câœ… æ‰€æœ‰åŠŸèƒ½å·²åŠ è¼‰å®Œæˆ', 'color: #28a745; font-size: 14px; font-weight: bold;');
        console.log('%cå¯ç”¨çš„é«˜ç´šåŠŸèƒ½:', 'color: #17a2b8; font-size: 12px;');
        console.log('- æ‹–æ”¾æ–‡ä»¶ç›´æ¥æ‰“é–‹');
        console.log('- è‡ªå‹•ä¿å­˜é–±è®€é€²åº¦');
        console.log('- è­·çœ¼æé†’ï¼ˆ30åˆ†é˜ï¼‰');
        console.log('- è§¸æ‘¸æ‰‹å‹¢ç¿»é ');
        console.log('- é–±è®€çµ±è¨ˆ');
        console.log('- ç­†è¨˜å°å‡º');

    </script>
</body>
</html>
